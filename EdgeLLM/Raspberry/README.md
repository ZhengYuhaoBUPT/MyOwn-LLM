# Run a large language model on your Raspberry Pi

From [Raspberry Pi Foundation](https://projects.raspberrypi.org/en/projects/llm-rpi/4)

We need to split the LLM in the edge. For the reason that we need Cloud-Edge collaborative, we use Docker for Kubernetes (kind) to deploy the LLM on both cloud and the edge.

## 🔹Solution: Deploy Kubernetes (Control Plane) Using Containerization on the L40

1. Running a Containerized Kubernetes Cluster (Local Isolated Environment).  

We can use kind (Kubernetes in Docker) to launch a Kubernetes cluster. Essentially, they run Kubernetes in Docker containers, isolated from the host machine and preventing contamination of the host environment.

kind is the most widely used, while k3d is more lightweight (based on k3s).

```
# Install kind
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind

# Create a local cluster
kind create cluster --name mycluster
```

This will start a master node in Docker on the L40. You can verify this by running
```
kubectl get nodes
```

2. Running KubeEdge (edgecore) on edge nodes  

Since you already have KubeEdge, then run edgecore directly on the edge nodes. The key is to enable the edge nodes to connect to the cloudcore on the L40.

3. Deploy KubeEdge cloudcore in an L40 containerized Kubernetes cluster.  

First, because the L40 is the server in school, I need to use the VPN for network connection. Install the .deb file using dpkg:
```
sudo dpkg -i '北邮VPN_arm64[https@vpn.bupt.edu.cn@443].deb'
```
turns out that Raspberry Pi can not use the VPN designed for PC. Then I tried for the SSL by openconnect.
```
sudo apt update
sudo apt install openconnect
sudo openconnect vpn.bupt.edu.cn
```
also failed, then choose to use windows for kubernetes.

Deployment can be done using keadm:

```
# Deploy cloudcore in a kind cluster
keadm init --advertise-address=<L40 public or private IP> --profile version=v1.15.0
```
Note: --advertise-address must be set to an L40 address accessible to edge nodes.

4. Join the edge node to the cloud  

On the edge node, execute:
```
keadm join --cloudcore-ipport=<L40_IP>:10000 --token=<auto-generated token>
```
If everything goes well, the edge node will be added to your kind/k3d containerized Kubernetes.

---

## 🔹Solution: Deploy Kubernetes (Control Plane) Using Containerization on the Windows PC
Kubernetes does not officially support native Master nodes on Windows, but you can use WSL2 + Docker + Kind/k3d to start a local containerized Kubernetes cluster:

### 1️⃣ On the Windows PC
1. Install WSL2 and Ubuntu
Start WSL2：
```
wsl --install
# install Ubuntu（Ubuntu 22.04 or 20.04）
# set WSL version to 2
wsl --set-version Ubuntu-22.04 2
```

2. Install Docker Desktop
[Download Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)
Enable the WSL2 backend during installation and select Ubuntu as the resource pool in the Docker Desktop settings.

3. Installing Kind (Kubernetes in Docker) in WSL2
Open the Ubuntu terminal in WSL2:
```
# Install kind
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-windows-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
# Create a local Kubernetes cluster
kind create cluster --name mycluster
```

4. Verify the cluster
```
kubectl get nodes
```
The output should show a single master node (the Kind cluster runs in a Docker container).

---
### 2️⃣ Deploy KubeEdge cloudcore on Windows Kubernetes
1. Install keadm
In the WSL2 Ubuntu terminal:
```
curl -sfL https://github.com/kubeedge/keadm/releases/download/v1.15.0/keadm-v1.15.0-linux-amd64.tar.gz | tar -xz
sudo mv keadm-v1.15.0-linux-amd64/keadm /usr/local/bin/
```

2. Deploy cloudcore
```
keadm init --advertise-address=<Windows-PC-IP> --profile version=v1.15.0
```
Note: --advertise-address must be an IP address accessible to the Raspberry Pi (either on the same LAN or after VPN/intranet penetration).

---

## 🔹Solution: Deploy Kubernetes (Control Plane) Using Containerization on the MACOS
Kubernetes does not officially support native Master nodes on Windows, but you can use Docker to start a local containerized Kubernetes cluster:

### 1️⃣ On the Mac PC
Install Docker Desktop

---

### 2️⃣ Install Kubectl
Install Docker Desktop and check, using kubeadm.
```
kubectl version --client
```
Expose the port to Raspberry Pi 5
```
kubectl proxy --address='0.0.0.0' --accept-hosts='^.\*$' --port=8001
```

---

### 3️⃣ Raspberry Pi joins the cloud (Edge Node)
1. Install Docker
```
# search for version
docker version
# delete former
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done

# update apt
sudo apt update
sudo apt upgrade

# Install Docker dependencies
sudo apt install apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release

# Add the GPG key
curl -fsSL https://get.docker.com | sh

# Add Alibaba Cloud's Docker repository
sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"

# Install Docker
sudo apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

2. Configure Docker.
Configure the user group and add the current user to the Docker group to avoid starting without permission.
```
sudo usermod -aG docker $USER

reboot
```

3. Configuring Docker Acceleration
```
sudo vi /etc/docker/daemon.json
# 直接复制进去并保存 （2025.2.15最新可用源,看到这里的同学评论一下是否还可用，不可用我会更新）
 {
  "registry-mirrors": [
    "https://docker.hpcloud.cloud",
    "https://docker.m.daocloud.io",
    "https://docker.unsee.tech",
    "https://docker.1panel.live",
    "http://mirrors.ustc.edu.cn",
    "https://docker.chenby.cn",
    "http://mirror.azure.cn",
    "https://dockerpull.org",
    "https://dockerhub.icu",
    "https://hub.rat.dev",
    "https://proxy.1panel.live",
    "https://docker.1panel.top",
    "https://docker.m.daocloud.io",
    "https://docker.1ms.run",
    "https://docker.ketches.cn"
  ]
}
# 启动/重启docker
sudo systemctl daemon-reload  
#如果还没启动
sudo systemctl start docker
#如果已经启动
sudo systemctl restart docker
# docker开机自启
sudo systemctl enable docker

# 验证镜像加速是否修改 查看Registry Mirrors部分
sudo docker info
```

4. Verification
```
sudo docker run hello-world
```

5. Install KubeEdge edgecore on a Raspberry Pi:
```
curl -sfL https://github.com/kubeedge/kubeedge/releases/download/v1.15.0/kubeedge-v1.15.0-linux-arm64.tar.gz | tar -xz
sudo mv kubeedge-v1.15.0-linux-arm64/edge/edgecore /usr/local/bin/
```
2. Configure the edgecore configuration file, edgecore.yaml:  
Specify the cloudcore address:
```
cloud:
controllers:
- name: devicecontroller
- name: twincontroller
- name: metadata
protocol: websocket
address: <Windows-PC-IP>:10000
```
Start edgecore:
```
sudo edgecore --config edgecore.yaml
```
If using a keadm token:
```
keadm join --cloudcore-ipport=<Windows-PC-IP>:10000 --token=<auto-generated-token>
```

---
